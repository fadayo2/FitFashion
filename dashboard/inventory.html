<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Management</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background-color: #09090b; /* Deep Obsidian */
      color: #f4f4f5;
    }

    /* Luxury Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #09090b; }
    ::-webkit-scrollbar-thumb { background: #daa520; border-radius: 10px; }

    .glass-card {
      background: rgba(24, 24, 27, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(218, 165, 32, 0.1);
    }

    .gold-glow:hover {
      border-color: #daa520;
      box-shadow: 0 0 20px rgba(218, 165, 32, 0.15);
    }

    .product-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #daa520 0%, #b8860b 100%);
      color: #000;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      filter: brightness(1.2);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px -5px rgba(218, 165, 32, 0.4);
    }

    .input-field {
      background: #18181b !important;
      border: 1px solid #27272a;
      color: white;
      transition: all 0.2s ease;
    }

    .input-field:focus {
      border-color: #daa520;
      box-shadow: 0 0 0 4px rgba(218, 165, 32, 0.1);
      outline: none;
    }

    .stock-input-mini {
      width: 60px;
      background: #daa520;
      border: none;
      border-radius: 8px;
      padding: 2px 4px;
      font-size: 10px;
      font-weight: 800;
      color: #000;
      outline: none;
      text-align: center;
    }

    .preview-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid #daa520;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fadeIn 0.4s ease forwards; }

    @keyframes toast-in {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(20px); }
    }
    .animate-toast-in { animation: toast-in 0.3s ease forwards; }
    .animate-toast-out { animation: toast-out 0.3s ease forwards; }
  </style>
</head>
<body class="antialiased text-zinc-200">

<div class="min-h-screen flex flex-col lg:flex-row">
  <main class="flex-1 p-6 lg:p-12 overflow-y-auto">
    
    <header class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
      <div>
        <h1 class="text-4xl font-bold tracking-tight text-white uppercase font-serif">Inventory<span class="text-goldenrod" style="color:#daa520">.</span></h1>
      </div>
      
      <div class="flex items-center gap-3">
        <button id="addProductBtn" class="btn-primary px-6 py-3 rounded-2xl font-bold flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Add New Product
        </button>
      </div>
    </header>

    <section class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      <div class="glass-card p-6 rounded-3xl border-t-2 border-t-zinc-800">
        <p class="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Total Collection</p>
        <h3 id="totalProducts" class="text-3xl font-bold text-white mt-2">0</h3>
      </div>
      <div class="glass-card p-6 rounded-3xl border-t-2 border-t-zinc-800">
        <p class="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Available Units</p>
        <h3 id="totalStock" class="text-3xl font-bold text-white mt-2">0</h3>
      </div>
      <div class="glass-card p-6 rounded-3xl border-t-2 border-t-amber-600/50">
        <p class="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Low Stock</p>
        <h3 id="lowStock" class="text-3xl font-bold text-amber-500 mt-2">0</h3>
      </div>
      <div class="glass-card p-6 rounded-3xl border-t-2 border-t-rose-600/50">
        <p class="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Sold Out</p>
        <h3 id="outStock" class="text-3xl font-bold text-rose-500 mt-2">0</h3>
      </div>
    </section>

    <div class="max-w-7xl mx-auto">
      <div class="flex flex-col md:flex-row gap-4 mb-8">
        <div class="relative flex-1">
          <input id="searchInput" type="text" placeholder="Search collection..." 
            class="w-full pl-6 pr-6 py-4 bg-zinc-900 border border-zinc-800 rounded-2xl focus:border-goldenrod focus:outline-none text-white placeholder:text-zinc-600 transition-all shadow-inner"/>
        </div>
        <select id="stockFilter" class="px-6 py-4 bg-zinc-900 border border-zinc-800 rounded-2xl text-zinc-400 font-bold focus:outline-none">
          <option value="all">Full Archive</option>
          <option value="in">Available</option>
          <option value="low">Low Inventory</option>
          <option value="out">Archived/Out</option>
        </select>
      </div>

      <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    </div>
  </main>
</div>

<div id="productModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl hidden flex items-center justify-center p-4 z-[100]">
  <div class="bg-zinc-950 w-full max-w-xl rounded-[2.5rem] shadow-2xl flex flex-col animate-in border border-zinc-800 max-h-[90vh]">
    <div class="p-8 border-b border-zinc-900 flex justify-between items-center">
        <h2 id="modalTitle" class="text-2xl font-serif font-bold text-white uppercase tracking-tight">Product Studio</h2>
        <button onclick="closeModal()" class="text-zinc-500 hover:text-white">✕</button>
    </div>
    <div class="flex-1 overflow-y-auto p-8 space-y-6">
        <input id="productName" type="text" placeholder="Product Name" class="w-full input-field px-5 py-4 rounded-2xl font-medium" />
        <div class="grid grid-cols-2 gap-6">
            <input id="productPrice" type="number" placeholder="Price ₦" class="w-full input-field px-5 py-4 rounded-2xl font-medium" />
            <input id="productStock" type="number" placeholder="Stock" class="w-full input-field px-5 py-4 rounded-2xl font-medium" />
        </div>
        <textarea id="productDescription" rows="3" placeholder="Description..." class="w-full input-field px-5 py-4 rounded-2xl font-medium resize-none"></textarea>
        <div class="border-2 border-dashed border-zinc-800 rounded-[2rem] p-8 text-center bg-zinc-900/50">
            <input id="productImages" type="file" multiple class="hidden" accept="image/*" />
            <label for="productImages" class="cursor-pointer text-zinc-400 font-bold hover:text-goldenrod transition-colors">Click to Upload Visuals</label>
        </div>
        <div id="imagePreviewContainer" class="flex flex-wrap gap-3"></div>
    </div>
    <div class="p-8 bg-zinc-900/30 flex gap-4">
        <button id="cancelModalBtn" class="flex-1 py-4 text-zinc-500 font-bold hover:text-white transition-colors">Discard</button>
        <button id="saveProductBtn" class="btn-primary flex-[2] py-4 rounded-2xl font-black uppercase tracking-tighter">Save Masterpiece</button>
    </div>
  </div>
</div>

<div id="toastContainer" class="fixed top-6 right-6 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://hjghemoxbyexeemwpjrx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZ2hlbW94YnlleGVlbXdwanJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5Nzg1MTksImV4cCI6MjA4NTU1NDUxOX0.N8_DlPNWXN733b0NrAg45-lN1NHMVJlDH63rDP9u86E"
);

let products = [];
let currentEditId = null;

// DOM elements
const addBtn = document.getElementById("addProductBtn");
const modal = document.getElementById("productModal");
const modalTitle = document.getElementById("modalTitle");
const saveBtn = document.getElementById("saveProductBtn");
const cancelBtn = document.getElementById("cancelModalBtn");
const searchInput = document.getElementById("searchInput");
const stockFilter = document.getElementById("stockFilter");
const grid = document.getElementById("productsGrid");
const nameInput = document.getElementById("productName");
const priceInput = document.getElementById("productPrice");
const stockInput = document.getElementById("productStock");
const descriptionInput = document.getElementById("productDescription");
const imageInput = document.getElementById("productImages");
const previewContainer = document.getElementById("imagePreviewContainer");

// ---------- Toast ----------
function showToast(message, type = 'success') {
  const container = document.getElementById("toastContainer");
  if (!container) return;

  const toast = document.createElement("div");
  const isSuccess = type === 'success';
  
  const icon = isSuccess 
    ? `<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>`
    : `<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>`;

  toast.className = `flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl animate-toast-in pointer-events-auto border border-white/20`;
  toast.style.background = "rgba(255, 255, 255, 0.95)";
  toast.style.backdropFilter = "blur(10px)";
  toast.style.minWidth = "280px";
  toast.style.borderLeft = `4px solid ${isSuccess ? '#10b981' : '#f43f5e'}`;
  
  toast.innerHTML = `
    <div class="p-2 ${isSuccess ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'} rounded-full">
      ${icon}
    </div>
    <p class="text-sm font-bold text-slate-800">${message}</p>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.add('animate-toast-out');
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}

// ---------- Image preview on file selection ----------
imageInput.addEventListener("change", () => {
  previewContainer.innerHTML = "";
  const files = imageInput.files;
  for (const file of files) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "preview-image animate-in";
      previewContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  }
});

// ---------- Upload images to Supabase storage ----------
async function uploadImages(files) {
  const urls = [];
  for (const file of files) {
    const filePath = `${Date.now()}-${file.name}`;
    const { error: uploadError } = await supabase.storage.from("products").upload(filePath, file);
    if (uploadError) throw uploadError;
    const { data } = supabase.storage.from("products").getPublicUrl(filePath);
    urls.push(data.publicUrl);
  }
  return urls;
}

// ---------- Open modal (for add / edit) ----------
function openModal(product = null) {
  currentEditId = product?.id || null;
  modalTitle.textContent = product ? "Edit Product" : "New Masterpiece";
  
  nameInput.value = product?.name || "";
  priceInput.value = product?.price || "";
  stockInput.value = product?.stock || "";
  descriptionInput.value = product?.description || "";
  
  // Reset file input
  imageInput.value = "";
  
  // Show existing images (if editing)
  previewContainer.innerHTML = "";
  if (product?.image_url && product.image_url.length > 0) {
    product.image_url.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.className = "preview-image animate-in";
      previewContainer.appendChild(img);
    });
  }
  
  modal.classList.remove("hidden");
}

// Make closeModal global for inline onclick
window.closeModal = function() {
  modal.classList.add("hidden");
};

cancelBtn.addEventListener("click", closeModal);

// ---------- Save product (add or edit) ----------
async function saveProduct() {
  const name = nameInput.value.trim();
  const price = Number(priceInput.value);
  const stock = Number(stockInput.value);
  const description = descriptionInput.value.trim();

  if (!name || isNaN(price) || isNaN(stock)) {
    alert("Please fill all required fields correctly.");
    return;
  }

  saveBtn.disabled = true;
  saveBtn.innerHTML = "Processing...";

  const files = imageInput.files;
  let imageUrls = [];

  try {
    // Upload new images if any
    if (files.length > 0) {
      imageUrls = await uploadImages(files);
    } else if (currentEditId) {
      // Keep existing images when editing without changing files
      const existing = products.find(p => p.id === currentEditId);
      imageUrls = existing?.image_url || [];
    }

    const productData = {
      name,
      price,
      stock,
      description,
      image_url: imageUrls,
      created_at: new Date()
    };

    let error;
    if (currentEditId) {
      ({ error } = await supabase.from("products").update(productData).eq("id", currentEditId));
    } else {
      ({ error } = await supabase.from("products").insert([productData]));
    }

    if (error) throw error;

    closeModal();
    await loadProducts(); // reload list
    showToast(currentEditId ? "Product updated successfully" : "New masterpiece added to collection");
  } catch (err) {
    console.error("Save error:", err);
    showToast("Save failed: " + err.message, "error");
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = "Confirm & Save";
  }
}

saveBtn.addEventListener("click", saveProduct);

// ---------- Delete product ----------
async function deleteProduct(id) {
  if (!confirm("Remove this item from the collection?")) return;
  const { error } = await supabase.from("products").delete().eq("id", id);
  if (error) {
    showToast("Delete failed: " + error.message, "error");
  } else {
    await loadProducts();
    showToast("Product removed from inventory", "success");
  }
}

// ---------- Quick stock edit (inline) ----------
window.startQuickEdit = function(element, productId, currentStock) {
  const input = document.createElement('input');
  input.type = 'number';
  input.value = currentStock;
  input.className = 'stock-input-mini';
  
  input.onclick = (e) => e.stopPropagation();

  const saveQuickEdit = async () => {
    const newStock = parseInt(input.value);
    if (isNaN(newStock) || newStock < 0) {
      showToast("Invalid stock number", "error");
      renderProducts(); // reset UI
      return;
    }

    if (newStock === currentStock) {
      renderProducts();
      return;
    }

    const { error } = await supabase
      .from("products")
      .update({ stock: newStock })
      .eq("id", productId);

    if (error) {
      showToast("Update failed", "error");
    } else {
      showToast(`Stock updated to ${newStock}`);
      const prodIndex = products.findIndex(p => p.id === productId);
      if (prodIndex !== -1) products[prodIndex].stock = newStock;
      renderProducts();
      updateStats();
    }
  };

  input.onkeydown = (e) => {
    if (e.key === 'Enter') saveQuickEdit();
    if (e.key === 'Escape') renderProducts();
  };

  input.onblur = saveQuickEdit;

  element.parentNode.replaceChild(input, element);
  input.focus();
  input.select();
};

// ---------- Render products grid ----------
function renderProducts() {
  grid.innerHTML = "";
  const search = searchInput.value.toLowerCase();
  const filter = stockFilter.value;

  const filtered = products.filter(p => {
    const matchSearch = p.name?.toLowerCase().includes(search);
    let matchStock = true;
    if (filter === "in") matchStock = p.stock > 5;
    if (filter === "low") matchStock = p.stock > 0 && p.stock <= 5;
    if (filter === "out") matchStock = p.stock === 0;
    return matchSearch && matchStock;
  });

  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="col-span-full py-20 text-center">
        <p class="text-slate-400 font-medium">No items found matching your criteria.</p>
      </div>
    `;
    return;
  }

  filtered.forEach(product => {
    const isOut = product.stock === 0;
    const isLow = product.stock <= 5 && product.stock > 0;

    const statusLabel = isOut ? "Out of Stock" : isLow ? "Low Stock" : "In Stock";
    const statusClass = isOut ? "bg-rose-950/50 text-rose-500 border border-rose-900" 
                    : isLow ? "bg-amber-950/50 text-amber-500 border border-amber-900" 
                    : "bg-emerald-950/50 text-emerald-500 border border-emerald-900";

    const card = document.createElement("div");
    card.className = "product-card glass-card p-5 rounded-[2.5rem] flex flex-col gold-glow";

    card.innerHTML = `
      <div class="relative group aspect-[4/5] rounded-[2rem] bg-zinc-900 mb-6 overflow-hidden border border-zinc-800">
        <img src="${product.image_url?.[0] || 'https://via.placeholder.com/600'}" class="w-full h-full object-cover transition-transform duration-700"/>
      </div>
      <div class="flex-1">
        <div class="flex justify-between items-start mb-2">
          <h3 class="font-bold text-white text-lg truncate pr-2 uppercase font-serif tracking-wide">${product.name}</h3>
        </div>
        <p class="text-[#daa520] font-black text-xl mb-4">₦${product.price.toLocaleString()}</p>
        <div class="flex flex-wrap gap-2 mb-6">
          <span class="text-[10px] font-bold px-3 py-1.5 rounded-xl uppercase tracking-widest ${statusClass}">${statusLabel}</span>
          <span onclick="event.stopPropagation(); startQuickEdit(this, '${product.id}', ${product.stock})"
                class="cursor-pointer bg-zinc-800 text-zinc-400 hover:text-[#daa520] transition-colors text-[10px] font-bold px-3 py-1.5 rounded-xl uppercase tracking-widest border border-zinc-700">
            ${product.stock} Units
          </span>
        </div>
      </div>
      <div class="flex gap-2 pt-4 border-t border-zinc-800">
        <button class="editBtn flex-1 py-3 text-sm font-bold text-zinc-400 hover:text-[#daa520] transition-all">Edit</button>
        <button class="deleteBtn flex-1 py-3 text-sm font-bold text-rose-900 hover:text-rose-500 transition-all">Delete</button>
      </div>
    `;

    card.querySelector(".editBtn").addEventListener("click", () => openModal(product));
    card.querySelector(".deleteBtn").addEventListener("click", () => deleteProduct(product.id));
    grid.appendChild(card);
  });
}

// ---------- Update stats cards ----------
function updateStats() {
  document.getElementById("totalProducts").textContent = products.length;
  document.getElementById("totalStock").textContent = products.reduce((sum, p) => sum + (p.stock || 0), 0);
  document.getElementById("lowStock").textContent = products.filter(p => p.stock > 0 && p.stock <= 5).length;
  document.getElementById("outStock").textContent = products.filter(p => p.stock === 0).length;
}

// ---------- Load products from Supabase ----------
async function loadProducts() {
  const { data, error } = await supabase.from("products").select("*").order("created_at", { ascending: false });
  if (error) {
    showToast("Error loading products: " + error.message, "error");
    return;
  }
  products = data || [];
  renderProducts();
  updateStats();
}

// ---------- Admin authorization ----------
async function initAdmin() {
  try {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error) throw error;

    const ADMIN_LIST = [
      "afadunmiye@gmail.com",
      "brosdipo@gmail.com"
    ];

    const userEmail = user?.email?.toLowerCase();
    const isAuthorized = userEmail && ADMIN_LIST.map(e => e.toLowerCase()).includes(userEmail);

    if (!isAuthorized) {
      console.warn("Unauthorized access attempt by:", user?.email);
      window.location.href = "../pages/login.html";
      return;
    }

    console.log("Admin verified:", userEmail);
    loadProducts();
  } catch (err) {
    console.error("Admin init error:", err);
    window.location.href = "../pages/login.html";
  }
}

// ---------- Event listeners for filtering ----------
searchInput.addEventListener("input", renderProducts);
stockFilter.addEventListener("change", renderProducts);
addBtn.addEventListener("click", () => openModal());

// Start the app
initAdmin();
</script>

</body>
</html>