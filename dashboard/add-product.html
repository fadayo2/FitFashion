<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Product</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Add Product</h1>

    <form id="productForm" class="space-y-4">
      <input id="name" placeholder="Product name"
        class="w-full border p-2 rounded" required />

      <textarea id="description" placeholder="Description"
        class="w-full border p-2 rounded"></textarea>

      <input id="price" type="number" placeholder="Price"
        class="w-full border p-2 rounded" required />

      <input id="image" type="file"
        class="w-full border p-2 rounded" accept="image/*" />

      <button class="bg-black text-white w-full py-2 rounded">
        Add Product
      </button>
    </form>

    <p id="message" class="mt-3 text-sm"></p>
  </div>


<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

export const supabase = createClient(
  "https://hjghemoxbyexeemwpjrx.supabase.co",
  "sb_publishable_lByAZQ0ZtFEYN9_G13E7Tg_e4RXrQG6"
);

  async function initAdminPage() {
    // ðŸ” AUTH CHECK
    const { data: authData, error: authError } =
      await supabase.auth.getUser();

    if (authError || !authData.user) {
      window.location.href = "/pages/login.html";
      return;
    }

    // ðŸ‘¤ PROFILE CHECK
    const { data: profile, error: profileError } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", authData.user.id)
      .maybeSingle();

    if (profileError || !profile || profile.role !== "admin") {
      alert("Access denied");
      window.location.href = "/";
      return;
    }

    // âœ… ADMIN VERIFIED â€” NOW SAFE TO TOUCH DOM
    const form = document.getElementById("productForm");
    const msg = document.getElementById("message");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const description = document.getElementById("description").value;
      const price = document.getElementById("price").value;
      const file = document.getElementById("image").files[0];

      let image_url = null;

      if (file) {
        const filePath = `${Date.now()}-${file.name}`;

        const { error: uploadError } = await supabase.storage
          .from("products")
          .upload(filePath, file);

        if (uploadError) {
          msg.textContent = uploadError.message;
          msg.className = "text-red-500";
          return;
        }

        const { data } = supabase.storage
          .from("products")
          .getPublicUrl(filePath);

        image_url = data.publicUrl;
      }

      const { error } = await supabase.from("products").insert({
        name,
        description,
        price,
        image_url
      });

      if (error) {
        msg.textContent = error.message;
        msg.className = "text-red-500";
        return;
      }

      msg.textContent = "Product added successfully âœ…";
      msg.className = "text-green-600";
      form.reset();
    });
  }

  initAdminPage();
</script>

</body>
</html>